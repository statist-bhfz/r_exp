---
title: "Plotly: интерактивная графика для R и не только"
output: html_document
---

```{r, echo=FALSE}
setwd("D:/GITHUB/r_exp/plotly")
```

[Plotly](https://plot.ly/) (plotly.js) является JavaScript-библиотекой для создания интерактивных графиков, построенной на основе [d3.js](http://d3js.org/) и [stack.gl](http://stack.gl/). Начиная с версии 2.0, ее исходный код стал открытым, а рендеринг графиков происходит на стороне пользователя, т.е. локально. В случае использования совместно с R это осуществляется посредством [htmlwidgets](http://www.htmlwidgets.org/). Имеется возможность встраивания графиков в сайты и приложения, также стоит отметить возможность хостинга на сервере разработчиков и наличие интерактивного [конструктора графиков](https://plot.ly/plot).

Помимо программирования непосредственно на языке JavaScript, доступ к возможностям библиотеки можно получить из других языков и приложений путем использования соответствующего [API](https://ru.wikipedia.org/wiki/API). Реализована поддержка R, Python, Julia, Matlab, Excel (!). Остановимся пока что на первом варианте, остальное - как-нибудь в другой раз.

Для начала нужно установить пакет (с CRAN или с GithHub):

```{r, eval=FALSE}
# Установка с CRAN:
install.packages("plotly")
# Установка самой свежей версии с GithHub:
devtools::install_github("ropensci/plotly")
```

```{r , echo=FALSE, message=FALSE, warning=FALSE}
library(plotly)
library(dplyr)
```

Далее есть три альтернативы:

1. Независимое использование (функция `plot_ly()` со своим собственным синтаксисом);

2. Использование в качестве надстройки на **ggplot2** (объект ggplot2 передается конвертирующей функции `ggplotly()`);

3. Встраивание в приложения Shiny (в этом сообщении не рассматривается, см. [примеры](https://plot.ly/r/shiny-tutorial/)).

На сайте разработчиков имеется большое количество справочных и обучающих материалов, но организованы они специфическим образом, поэтому найти ответ на конкретный вопрос не всегда легко. Обязательны для ознакомления следующие страницы:

* [Главная страница справки](https://plot.ly/r/): содержит ссылки на другие материалы (не пропустите неприметные ссылки внизу страницы), часть из них не работает (например, Layout Options); можно посмотреть примеры различных типов графиков;

* [Plotly for R User Guide](https://plot.ly/r/user-guide/): рассмотрено несколько примеров, но на сколько-нибудь полноценное руководство не тянет; показано, как комбинировать в одном конвейере манипуляции с данными и поэтапное построение графика;

* [Chart attributes](https://plot.ly/r/reference/): дополнение к встроенной справке по функциям `plot_ly()`, `layout()`, `add_trace()` и `style()`; приведены наиболее ценные примеры, показывающие, как сочетать различные элементы графиков для наиболее полного контроля над их внешним видом;

* [Руководство по использованию с ggplot2](https://plot.ly/ggplot2/): показано, как можно создать объект средствами **ggplot2**, а затем сконвертировать его в объект **plotly**;

* [Plotly and ggplot2 UseR Guide](https://plot.ly/ggplot2/user-guide/): показано, как можно редактировать сконвертированный из **ggplot2** объект.

Также имеется [виньетка](https://cran.r-project.org/web/packages/plotly/vignettes/intro.html) на CRAN.

Пакет **plotly** предоставляет свой [DSL](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B5%D0%B4%D0%BC%D0%B5%D1%82%D0%BD%D0%BE-%D0%BE%D1%80%D0%B8%D0%B5%D0%BD%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9_%D1%8F%D0%B7%D1%8B%D0%BA), подобный **ggplot2**. Базовый график создается при помощи функции `plot_ly()` (аналог `ggplot()`), представления данных добавляются при помощи `add_trace()` (аналог семейства функций `geom_()`), за все общие атрибуты графика типа подписей к осям отвечает функция `layout()`. Добавлять элементы к графику можно двумя способами. 

Первый способ - сохранение графика и передача переменной, которая на него ссылается, в качестве первого аргумента функций `add_trace()` и `layout()`:

```{r, eval=FALSE}
p <- plot_ly(...)
p <- add_trace(p, ...)
p <- layout(p, ...)
```

Альтернативный вариант - использование конвейерного оператора `%>%`, хорошо знакомого по пакету **dplyr**, который позволяет объединять трансформацию данных и визуализацию в одну цепочку операций:

```{r, eval=FALSE}
p <- plot_ly(...) %>%
    add_trace(...) %>%
    layout(...)
```

Рассмотрим слегка измененный пример из документации.

```{r}
p <- plot_ly(economics,
    type = "scatter",
    x = date,
    y = uempmed,
    name = "unemployment", 
    mode = "lines+markers",
    line = list(
        color = "pink"
    ),
    marker = list(
        color = "red",
        size = 4
    )
)
```

На данном этапе создан график, соответствующий временному ряду:

* используется набор данных `economics`;

* тип графика - `"scatter"` - позволяет рисовать точки и линии;

* ось `x` соответствует переменной `date`, ось `y` - переменной `uempmed`;

* `name = "unemployment"` задает "имя", которое будет отображаться в легенде;

* `mode = "lines+markers"` - рисуем линию и точки (по умолчанию, если значений больше 20, рисуется только линия);

* цвет линии - розовый, цвет точек - красный, размер - 4 (по умолчанию - 6).

Таким образом, атрибуты точек, линий и других элементов графика задаются в виде списка.

Добавим сглаживание методом локальной регрессии (loess):

```{r}
p <- add_trace(p,                       
    y = fitted((loess(uempmed ~ as.numeric(date)))),
    name = "loess",
    mode = "lines",
    line = list(                   
        color = "black",     
        dash = "dashed"              
    )
)
```

Найдем строку данных, соответствующую максимальному значению переменной `uempmed`:

```{r}
maxdf <- economics %>% filter(uempmed == max(uempmed))
```

Добавим название графика и подписи осей; отметим максимальное значение на графике: 

```{r}
p <- layout(p,  
    title = "График, созданный при помощи <br> <a href='https://plot.ly/'>Plotly</a>",
    xaxis = list( 
        title = "Время",     
        showgrid = FALSE 
    ),
    yaxis = list(          
        title = "Перерыв в работе (медиана), <sub>нед.</sub>"     
    ),
    annotations = list(        
        list(
            x = maxdf$date,     
            y = maxdf$uempmed,  
            text = "Максимум",      
            showarrow = TRUE      
        )
    )
)
p
```

В этом примере использована имеющаяся поддержка HTML-тегов, в том числе гиперссылок, что может быть весьма полезно.

Теперь о плохом, то есть о замеченном баге:

[Не работает](https://ru.stackoverflow.com/questions/478133/latex-%D0%B2-plotly-r) заявленная поддержка LaTeX. [Artem Klevtsov](https://ru.stackoverflow.com/users/17269/artem-klevtsov) помог разобраться, был написан [багрепорт](https://github.com/ropensci/plotly/issues/375), ждем исправлений.

Еще из интересных возможностей хочу отметить встраивание одного графика в другой:

```{r}
p1 <- plot_ly(x = c(1, 2, 3), y = c(4, 3, 2))
p2 <- plot_ly(x = c(20, 30, 40), y = c(30, 40, 50)) %>%
  layout(xaxis = list(domain = c(0.6, 0.95)),
         yaxis = list(domain = c(0.6, 0.95)))
subplot(p1, p2)
```

Наконец, если не хочется тратить время на изучение нового синтаксиса, можно рисовать графики привычными средствами **ggplot2**, а затем конвертировать их в интерактивный вариант.

```{r}
dsamp <- diamonds[sample(nrow(diamonds), 1000), ]
p <- ggplot(data = dsamp, aes(x = carat, y = price)) +
    geom_point(aes(text = paste("Clarity:", clarity))) +
    geom_smooth(aes(colour = cut, fill = cut), size = 0.1) +
    facet_wrap(~cut)
gg <- ggplotly(p)
gg
```

Был задан параметр `size = 0.1`, иначе после конвертирования линия будет очень толстой. Это баг, который вроде бы недавно был исправлен, то есть в новых версиях конвертирование должно происходить более правильным образом.



```{r, eval=FALSE, echo=FALSE}
output:
  html_document:
    mathjax: null
    self_contained: false
    includes:
      in_header: mathjax.html
```



